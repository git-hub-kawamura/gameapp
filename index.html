<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üë∏ ËÑ±Âá∫ÔºÅ„Éñ„É≠„ÉÉ„ÇØÂ¥©„Åó</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: radial-gradient(ellipse at center, #1a1a3e 0%, #060612 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #fff;
      user-select: none;
      padding: 12px;
    }

    #game-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: auto;
      border: 2px solid #4a90d9;
      border-bottom: none;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 0 40px rgba(74, 144, 217, 0.4);
      cursor: none;
    }

    /* ‚îÄ‚îÄ „Ç≠„É£„É©„ÇØ„Çø„Éº„Éë„Éç„É´ ‚îÄ‚îÄ */
    #char-panel {
      width: 100%;
      background: #0d1b3e;
      border: 2px solid #4a90d9;
      border-radius: 0 0 12px 12px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      box-sizing: border-box;
    }

    #char-face {
      font-size: 46px;
      line-height: 1;
      min-width: 54px;
      text-align: center;
      transition: transform 0.15s;
    }
    #char-face.pop { transform: scale(1.5); }

    #char-info { flex: 1; }

    #char-message {
      font-size: 13px;
      color: #99aacc;
      margin-bottom: 7px;
      min-height: 18px;
    }

    #bar-wrap {
      background: #1a1a3e;
      border-radius: 10px;
      height: 14px;
      overflow: hidden;
      border: 1px solid #2a3a6a;
    }

    #escape-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #f39c12, #e74c3c);
      border-radius: 10px;
      transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    #key-count {
      font-size: 18px;
      font-weight: bold;
      color: #f39c12;
      min-width: 72px;
      text-align: right;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ „Ç™„Éº„Éê„Éº„É¨„Ç§ ‚îÄ‚îÄ */
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    #overlay.show { display: flex; }

    .ov-box {
      background: linear-gradient(135deg, #0d1b3e 0%, #1a2a5e 100%);
      border: 3px solid #4a90d9;
      border-radius: 22px;
      padding: 44px 54px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 24px 64px rgba(0,0,0,0.6),
                  0 0 40px rgba(74,144,217,0.25);
      animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes popIn {
      from { transform: scale(0.4); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }

    #ov-emoji { font-size: 68px; display: block; margin-bottom: 10px; }
    #ov-title { font-size: 38px; font-weight: bold; margin-bottom: 8px; }
    #ov-sub   { font-size: 15px; color: #8899bb; margin-bottom: 16px; }

    #ov-score {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 24px;
      font-size: 15px;
      color: #f39c12;
      white-space: pre-line;
      line-height: 1.8;
    }

    #ov-btn {
      background: linear-gradient(135deg, #4a90d9, #1565c0);
      color: #fff;
      border: none;
      padding: 14px 36px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    #ov-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(74,144,217,0.5);
    }
    #ov-btn:active { transform: translateY(0); }

    #ov-hs {
      margin-top: 14px;
      font-size: 13px;
      color: #556;
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
    <canvas id="gameCanvas" width="480" height="580"></canvas>
    <div id="char-panel">
      <div id="char-face">üîí</div>
      <div id="char-info">
        <div id="char-message">Èçµ„Éñ„É≠„ÉÉ„ÇØÔºàüîëÔºâ„ÇíÂÖ®ÈÉ®Â£ä„Åó„Å¶ËÑ±Âá∫„Åï„Åõ„Çà„ÅÜÔºÅ</div>
        <div id="bar-wrap"><div id="escape-bar"></div></div>
      </div>
      <div id="key-count">0 / ? üîë</div>
    </div>
  </div>

  <!-- „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ / „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div id="overlay">
    <div class="ov-box">
      <span id="ov-emoji">üë∏</span>
      <div id="ov-title">„ÇØ„É™„Ç¢ÔºÅ</div>
      <div id="ov-sub"></div>
      <div id="ov-score"></div>
      <button id="ov-btn" onclick="onOverlayBtn()">Ê¨°„Å∏</button>
      <div id="ov-hs"></div>
    </div>
  </div>

  <script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const canvas = document.getElementById('gameCanvas');
  const ctx    = canvas.getContext('2d');
  const W = canvas.width;   // 480
  const H = canvas.height;  // 580

  // roundRect „Éù„É™„Éï„Ç£„É´ÔºàÂè§„ÅÑ„Éñ„É©„Ç¶„Ç∂ÂØæÁ≠ñÔºâ
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
      r = r || 0;
      this.moveTo(x + r, y);
      this.lineTo(x + w - r, y);
      this.quadraticCurveTo(x + w, y, x + w, y + r);
      this.lineTo(x + w, y + h - r);
      this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      this.lineTo(x + r, y + h);
      this.quadraticCurveTo(x, y + h, x, y + h - r);
      this.lineTo(x, y + r);
      this.quadraticCurveTo(x, y, x + r, y);
      this.closePath();
    };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  ÂÆöÊï∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const HUD_H     = 56;
  const BLOCK_COLS = 5;
  const BLOCK_W   = 82;
  const BLOCK_H   = 24;
  const BLOCK_GX  = 6;   // Ê®™„ÅÆ„Åô„Åç„Åæ
  const BLOCK_GY  = 6;   // Á∏¶„ÅÆ„Åô„Åç„Åæ
  const BLOCK_OY  = HUD_H + 8; // „Éñ„É≠„ÉÉ„ÇØÈñãÂßãY
  const PADDLE_W  = 100;
  const PADDLE_H  = 14;
  const PADDLE_Y  = H - 42;
  const BALL_R    = 8;
  const HS_KEY    = 'datsutsu_hs';

  // „Çπ„ÉÜ„Éº„Ç∏Ë®≠ÂÆö
  const STAGES = [
    { keyCount: 3,  normalCount: 12, rows: 3, timeLimit: 60, baseSpeed: 4.0 },
    { keyCount: 5,  normalCount: 20, rows: 5, timeLimit: 50, baseSpeed: 4.5 },
    { keyCount: 7,  normalCount: 28, rows: 7, timeLimit: 40, baseSpeed: 5.0 },
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Ç≤„Éº„É†Áä∂ÊÖã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let gState     = 'menu'; // menu | playing | gameOver | stageClear | complete
  let stageIdx   = 0;
  let totalScore = 0;
  let timeLeft   = 60;
  let timeFrac   = 0;

  let ball      = { x: 0, y: 0, vx: 0, vy: 0 };
  let paddleX   = (W - PADDLE_W) / 2;
  let targetPX  = paddleX;
  let blocks    = [];
  let keysBroken = 0;
  let totalKeys  = 0;
  let particles  = [];
  let timeBonuses = []; // "+10s" „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„Éà

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  ÂÖ•Âäõ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const keys = {};
  document.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (e.code === 'Space' && gState === 'menu') startGame();
  });
  document.addEventListener('keyup', e => { keys[e.code] = false; });

  function toLogicalX(clientX) {
    const rect  = canvas.getBoundingClientRect();
    const scale = W / rect.width;
    return (clientX - rect.left) * scale;
  }

  canvas.addEventListener('mousemove', e => {
    targetPX = toLogicalX(e.clientX) - PADDLE_W / 2;
  });

  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    targetPX = toLogicalX(e.touches[0].clientX) - PADDLE_W / 2;
  }, { passive: false });

  canvas.addEventListener('click', () => {
    if (gState === 'menu') startGame();
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  ÂàùÊúüÂåñ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function startGame() {
    totalScore = 0;
    stageIdx   = 0;
    initStage();
  }

  function initStage() {
    const cfg    = STAGES[stageIdx];
    timeLeft     = cfg.timeLimit;
    timeFrac     = 0;
    keysBroken   = 0;
    totalKeys    = cfg.keyCount;
    particles    = [];
    timeBonuses  = [];

    paddleX = targetPX = (W - PADDLE_W) / 2;
    resetBall();
    generateBlocks(cfg);
    updateCharPanel();
    gState = 'playing';
  }

  function resetBall() {
    const cfg   = STAGES[stageIdx];
    // ‰∏äÊñπÂêë„É©„É≥„ÉÄ„É†ËßíÂ∫¶ (¬±20¬∞)
    const angle = -Math.PI / 2 + (Math.random() * 0.7 - 0.35);
    ball = {
      x:  W / 2,
      y:  PADDLE_Y - 30,
      vx: Math.cos(angle) * cfg.baseSpeed,
      vy: Math.sin(angle) * cfg.baseSpeed,
    };
  }

  function generateBlocks(cfg) {
    blocks = [];
    const total = cfg.keyCount + cfg.normalCount;
    const types = [
      ...Array(cfg.keyCount).fill('key'),
      ...Array(cfg.normalCount).fill('normal'),
    ];
    // Fisher-Yates „Ç∑„É£„ÉÉ„Éï„É´
    for (let i = types.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [types[i], types[j]] = [types[j], types[i]];
    }

    const totalW = BLOCK_COLS * BLOCK_W + (BLOCK_COLS - 1) * BLOCK_GX;
    const startX = (W - totalW) / 2;

    for (let r = 0; r < cfg.rows; r++) {
      for (let c = 0; c < BLOCK_COLS; c++) {
        const idx = r * BLOCK_COLS + c;
        if (idx >= total) break;
        blocks.push({
          x:    startX + c * (BLOCK_W + BLOCK_GX),
          y:    BLOCK_OY + r * (BLOCK_H + BLOCK_GY),
          type: types[idx],
          alive: true,
        });
      }
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  Êõ¥Êñ∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function update(dt) {
    if (gState !== 'playing') return;

    // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
    if (keys['ArrowLeft'])  targetPX -= 400 * dt;
    if (keys['ArrowRight']) targetPX += 400 * dt;

    // „Éë„Éâ„É´„Çí„Å™„ÇÅ„Çâ„Åã„Å´ËøΩÂæì
    paddleX += (targetPX - paddleX) * Math.min(dt * 16, 1);
    paddleX  = clamp(paddleX, 0, W - PADDLE_W);

    // „Çø„Ç§„Éû„Éº
    timeFrac += dt;
    if (timeFrac >= 1) {
      timeFrac -= 1;
      timeLeft  = Math.max(0, timeLeft - 1);
    }
    if (timeLeft <= 0) { doGameOver('timeout'); return; }

    // „Éú„Éº„É´ÈÄüÂ∫¶ÔºàÊôÇÈñìÁµåÈÅé„Åß„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó: 10Áßí„Åî„Å® +8%Ôºâ
    const cfg       = STAGES[stageIdx];
    const elapsed   = cfg.timeLimit - timeLeft;
    const speedMult = 1 + elapsed * 0.008;
    const speed     = cfg.baseSpeed * speedMult;

    const curSpd = Math.hypot(ball.vx, ball.vy);
    if (curSpd > 0) {
      ball.vx = (ball.vx / curSpd) * speed;
      ball.vy = (ball.vy / curSpd) * speed;
    }

    // „Éú„Éº„É´ÁßªÂãï
    ball.x += ball.vx;
    ball.y += ball.vy;

    // Â£Å„Å®„ÅÆË°ùÁ™Å
    if (ball.x - BALL_R < 0)  { ball.x = BALL_R;      ball.vx =  Math.abs(ball.vx); }
    if (ball.x + BALL_R > W)  { ball.x = W - BALL_R;  ball.vx = -Math.abs(ball.vx); }
    if (ball.y - BALL_R < HUD_H) { ball.y = HUD_H + BALL_R; ball.vy = Math.abs(ball.vy); }

    // ÁîªÈù¢Â§ñÔºàËêΩ‰∏ãÔºâ ‚Üí „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
    if (ball.y - BALL_R > H) { doGameOver('fall'); return; }

    // „Éë„Éâ„É´„Å®„ÅÆË°ùÁ™Å
    if (
      ball.vy > 0 &&
      ball.y + BALL_R >= PADDLE_Y &&
      ball.y - BALL_R <= PADDLE_Y + PADDLE_H &&
      ball.x >= paddleX - 4 &&
      ball.x <= paddleX + PADDLE_W + 4
    ) {
      ball.y = PADDLE_Y - BALL_R;
      // „Éí„ÉÉ„Éà‰ΩçÁΩÆ„ÅßÂèçÂ∞ÑËßí„ÇíÂà∂Âæ°
      const rel    = clamp((ball.x - paddleX) / PADDLE_W, 0, 1);
      const bAngle = (rel - 0.5) * Math.PI * 0.75; // ¬±67.5¬∞
      ball.vx = Math.sin(bAngle) * speed;
      ball.vy = -Math.abs(Math.cos(bAngle) * speed);
      // ÁúüÊ®™„Å´È£õ„Å∞„Å™„ÅÑÊúÄ‰Ωé‰øùË®º
      if (Math.abs(ball.vy) < speed * 0.25) {
        ball.vy = -speed * 0.25;
        ball.vx = Math.sign(ball.vx) * Math.sqrt(speed * speed - ball.vy * ball.vy);
      }
    }

    // „Éñ„É≠„ÉÉ„ÇØ„Å®„ÅÆË°ùÁ™ÅÔºà1„Éï„É¨„Éº„É†„Å´1„Éñ„É≠„ÉÉ„ÇØÔºâ
    for (const b of blocks) {
      if (!b.alive) continue;
      const bR = b.x + BLOCK_W, bB = b.y + BLOCK_H;
      if (ball.x + BALL_R < b.x || ball.x - BALL_R > bR ||
          ball.y + BALL_R < b.y || ball.y - BALL_R > bB) continue;

      // „Å©„ÅÆÈù¢„Å´ÂΩì„Åü„Å£„Åü„Åã„ÇíÊúÄÂ∞è„Ç™„Éº„Éê„Éº„É©„ÉÉ„Éó„ÅßÂà§ÂÆö
      const oL = (ball.x + BALL_R) - b.x;
      const oR = bR - (ball.x - BALL_R);
      const oT = (ball.y + BALL_R) - b.y;
      const oB = bB - (ball.y - BALL_R);
      const m  = Math.min(oL, oR, oT, oB);

      if      (m === oL) { ball.x = b.x - BALL_R;  ball.vx = -Math.abs(ball.vx); }
      else if (m === oR) { ball.x = bR + BALL_R;   ball.vx =  Math.abs(ball.vx); }
      else if (m === oT) { ball.y = b.y - BALL_R;  ball.vy = -Math.abs(ball.vy); }
      else               { ball.y = bB + BALL_R;   ball.vy =  Math.abs(ball.vy); }

      b.alive = false;
      spawnParticles(b.x + BLOCK_W / 2, b.y + BLOCK_H / 2, b.type);

      if (b.type === 'key') {
        keysBroken++;
        timeLeft += 10;
        timeBonuses.push({ x: b.x + BLOCK_W / 2, y: b.y + BLOCK_H / 2, life: 1.0 });
        updateCharPanel();
        if (keysBroken >= totalKeys) { doStageClear(); return; }
      }
      break;
    }

    // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Êõ¥Êñ∞
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.x  += p.vx;
      p.y  += p.vy;
      p.vy += 0.18;
      p.life -= dt * 2;
      if (p.life <= 0) particles.splice(i, 1);
    }

    // „Çø„Ç§„É†„Éú„Éº„Éä„Çπ„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
    for (let i = timeBonuses.length - 1; i >= 0; i--) {
      const tb = timeBonuses[i];
      tb.y -= 60 * dt;
      tb.life -= dt * 0.8;
      if (tb.life <= 0) timeBonuses.splice(i, 1);
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Éë„Éº„ÉÜ„Ç£„ÇØ„É´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function spawnParticles(cx, cy, type) {
    const color = type === 'key' ? '#f5c842' : '#4a90d9';
    for (let i = 0; i < 10; i++) {
      const a = (Math.PI * 2 / 10) * i + Math.random() * 0.5;
      const s = 2 + Math.random() * 3.5;
      particles.push({
        x: cx, y: cy,
        vx: Math.cos(a) * s,
        vy: Math.sin(a) * s,
        color,
        life: 1,
        size: 3 + Math.random() * 3,
      });
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Ç≤„Éº„É†„Ç§„Éô„É≥„Éà
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function doGameOver(reason) {
    gState = 'gameOver';
    const isTimeout = reason === 'timeout';
    showOverlay({
      emoji:      isTimeout ? 'üò¢' : 'üò±',
      title:      isTimeout ? '„Éï„ÉØ„Ç°„Äúüò¢' : '„Éû„É≥„Éû„Éü„Éº„Ç¢ÔºÅ',
      titleColor: '#e74c3c',
      sub:        isTimeout ? 'ÊôÇÈñìÂàá„Çå...Èñì„Å´Âêà„Çè„Å™„Åã„Å£„ÅüÔºÅ' : '„Éú„Éº„É´„ÇíËêΩ„Å®„Åó„Å¶„Åó„Åæ„Å£„ÅüÔºÅ',
      scoreText:  `„Çπ„Ç≥„Ç¢: ${totalScore.toLocaleString()} pt`,
      btnText:    '„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÉÅ„É£„É¨„É≥„Ç∏',
      onBtn: () => {
        totalScore = 0;
        stageIdx   = 0;
        initStage();
      },
    });
  }

  function doStageClear() {
    const isLast     = stageIdx >= STAGES.length - 1;
    const stageScore = Math.floor(timeLeft * 100 * (stageIdx + 1));
    totalScore      += stageScore;
    gState           = isLast ? 'complete' : 'stageClear';

    if (isLast) {
      const prevHS = parseInt(localStorage.getItem(HS_KEY) || '0');
      const isNew  = totalScore > prevHS;
      if (isNew) localStorage.setItem(HS_KEY, totalScore);
      showOverlay({
        emoji:      'üéâ',
        title:      '„É§„ÉÉ„Éï„ÉºÔºÅ',
        titleColor: '#f39c12',
        sub:        'ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅÂÆåÂÖ®ËÑ±Âá∫ÊàêÂäüÔºÅüë∏‚ú®',
        scoreText:  `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${totalScore.toLocaleString()} pt\n${isNew ? 'üèÜ NEW „Éè„Ç§„Çπ„Ç≥„Ç¢ÔºÅ' : `„Éè„Ç§„Çπ„Ç≥„Ç¢: ${Math.max(prevHS, totalScore).toLocaleString()} pt`}`,
        btnText:    '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂',
        onBtn: () => { totalScore = 0; stageIdx = 0; gState = 'menu'; },
      });
    } else {
      showOverlay({
        emoji:      'üèÉ‚Äç‚ôÄÔ∏è',
        title:      '„É§„ÉÉ„Éï„ÉºÔºÅ',
        titleColor: '#2ecc71',
        sub:        `„Çπ„ÉÜ„Éº„Ç∏ ${stageIdx + 1} „ÇØ„É™„Ç¢ÔºÅ`,
        scoreText:  `„Çπ„ÉÜ„Éº„Ç∏„Çπ„Ç≥„Ç¢: +${stageScore.toLocaleString()} pt\nÂêàË®à: ${totalScore.toLocaleString()} pt`,
        btnText:    `„Çπ„ÉÜ„Éº„Ç∏ ${stageIdx + 2} „Å∏ ‚ñ∂`,
        onBtn: () => { stageIdx++; initStage(); },
      });
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Ç™„Éº„Éê„Éº„É¨„Ç§
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let pendingAction = null;

  function showOverlay({ emoji, title, titleColor, sub, scoreText, btnText, onBtn }) {
    document.getElementById('ov-emoji').textContent = emoji;
    const titleEl = document.getElementById('ov-title');
    titleEl.textContent  = title;
    titleEl.style.color  = titleColor;
    document.getElementById('ov-sub').textContent   = sub;
    document.getElementById('ov-score').textContent = scoreText;
    document.getElementById('ov-btn').textContent   = btnText;

    const hs = parseInt(localStorage.getItem(HS_KEY) || '0');
    document.getElementById('ov-hs').textContent = hs > 0 ? `Ê≠¥‰ª£„Éè„Ç§„Çπ„Ç≥„Ç¢: ${hs.toLocaleString()} pt` : '';

    pendingAction = onBtn;
    document.getElementById('overlay').classList.add('show');
  }

  function onOverlayBtn() {
    document.getElementById('overlay').classList.remove('show');
    if (pendingAction) { const fn = pendingAction; pendingAction = null; fn(); }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Ç≠„É£„É©„Éë„Éç„É´Êõ¥Êñ∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function updateCharPanel() {
    const pct = totalKeys > 0 ? keysBroken / totalKeys : 0;

    document.getElementById('escape-bar').style.width = (pct * 100) + '%';
    document.getElementById('key-count').textContent  = `${keysBroken} / ${totalKeys} üîë`;

    const face = document.getElementById('char-face');
    const msg  = document.getElementById('char-message');

    // „Éù„ÉÉ„Éó„Ç¢„Éã„É°
    face.classList.remove('pop');
    void face.offsetWidth;
    face.classList.add('pop');
    setTimeout(() => face.classList.remove('pop'), 300);

    if (pct === 0) {
      face.textContent = 'üîí';
      msg.textContent  = 'Èçµ„Éñ„É≠„ÉÉ„ÇØÔºàüîëÔºâ„ÇíÂÖ®ÈÉ®Â£ä„Åó„Å¶ËÑ±Âá∫„Åï„Åõ„Çà„ÅÜÔºÅ';
    } else if (pct < 0.34) {
      face.textContent = 'üò∞';
      msg.textContent  = '„Åü„Åô„Åë„Å¶„ÉºÔºÅÔºÅÈçµ„ÇíÂ£ä„Åó„Å¶ÔºÅ';
    } else if (pct < 0.67) {
      face.textContent = 'üò§';
      msg.textContent  = '„ÇÇ„ÅÜ„Åô„ÅêËÑ±Âá∫„Åß„Åç„Çã...ÔºÅÈ†ëÂºµ„Å£„Å¶ÔºÅ';
    } else if (pct < 1) {
      face.textContent = 'üèÉ‚Äç‚ôÄÔ∏è';
      msg.textContent  = '„ÅÇ„Å®Â∞ë„ÅóÔºÅÔºÅÊÄ•„ÅÑ„ÅßÔºÅÔºÅ';
    } else {
      face.textContent = 'üéâ';
      msg.textContent  = '„ÇÑ„Å£„Åü„ÉºÔºÅËÑ±Âá∫ÊàêÂäüÔºÅÔºÅ';
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  ÊèèÁîª
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function render() {
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = '#080814';
    ctx.fillRect(0, 0, W, H);

    if (gState === 'menu') { renderMenu(); return; }

    renderHUD();
    renderBlocks();
    renderParticles();
    renderTimeBonuses();
    renderPaddle();
    renderBall();
  }

  // ‚îÄ‚îÄ „É°„Éã„É•„Éº ‚îÄ‚îÄ
  function renderMenu() {
    // Êòü
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    for (let i = 0; i < 70; i++) {
      const x = (i * 71 + 13) % W;
      const y = (i * 101 + 31) % H;
      const r = i % 4 === 0 ? 1.5 : 0.7;
      ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
    }

    ctx.textAlign = 'center';

    // „Çø„Ç§„Éà„É´
    ctx.font      = 'bold 36px Arial';
    ctx.fillStyle = '#fff';
    ctx.fillText('üë∏ ËÑ±Âá∫ÔºÅ„Éñ„É≠„ÉÉ„ÇØÂ¥©„Åó', W / 2, H / 2 - 100);

    ctx.font      = '16px Arial';
    ctx.fillStyle = '#7fa8d9';
    ctx.fillText('Èçµ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂÖ®ÈÉ®Â£ä„Åó„Å¶Âß´„ÇíÊïë„ÅàÔºÅ', W / 2, H / 2 - 55);

    ctx.font      = '13px Arial';
    ctx.fillStyle = '#556';
    ctx.fillText('ÂÖ®3„Çπ„ÉÜ„Éº„Ç∏ „Éª „Çø„Ç§„É†„Éú„Éº„Éä„Çπ „Éª „Éè„Ç§„Çπ„Ç≥„Ç¢Ë®òÈå≤', W / 2, H / 2 - 25);

    // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥ÔºàÁÇπÊªÖÔºâ
    const pulse = 0.65 + 0.35 * Math.sin(Date.now() / 380);
    ctx.globalAlpha = pulse;
    ctx.font        = 'bold 22px Arial';
    ctx.fillStyle   = '#4a90d9';
    ctx.fillText('„ÇØ„É™„ÉÉ„ÇØ Ôºè „Çπ„Éö„Éº„Çπ„Ç≠„Éº „Åß„Çπ„Çø„Éº„Éà', W / 2, H / 2 + 40);
    ctx.globalAlpha = 1;

    // Êìç‰ΩúË™¨Êòé
    ctx.font      = '13px Arial';
    ctx.fillStyle = '#445';
    ctx.fillText('„Éû„Ç¶„Çπ Ôºè ‚Üê‚Üí „Ç≠„Éº„Åß„Éë„Éâ„É´Êìç‰Ωú', W / 2, H / 2 + 80);

    // „Éè„Ç§„Çπ„Ç≥„Ç¢
    const hs = parseInt(localStorage.getItem(HS_KEY) || '0');
    if (hs > 0) {
      ctx.font      = 'bold 16px Arial';
      ctx.fillStyle = '#f39c12';
      ctx.fillText(`üèÜ ÊúÄÈ´ò„Çπ„Ç≥„Ç¢: ${hs.toLocaleString()} pt`, W / 2, H / 2 + 120);
    }
  }

  // ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
  function renderHUD() {
    ctx.fillStyle = '#0d1b3e';
    ctx.fillRect(0, 0, W, HUD_H);

    ctx.strokeStyle = '#2a4a8a';
    ctx.lineWidth   = 1;
    ctx.beginPath(); ctx.moveTo(0, HUD_H); ctx.lineTo(W, HUD_H); ctx.stroke();

    // „Çπ„ÉÜ„Éº„Ç∏
    ctx.textAlign = 'left';
    ctx.font      = 'bold 11px Arial';
    ctx.fillStyle = '#4a90d9';
    ctx.fillText('STAGE', 15, 22);
    ctx.font      = 'bold 30px Arial';
    ctx.fillStyle = '#fff';
    ctx.fillText(stageIdx + 1, 15, 50);

    // „Çø„Ç§„Éû„Éº
    const cfg     = STAGES[stageIdx];
    const urgency = timeLeft / cfg.timeLimit;
    ctx.fillStyle = urgency < 0.2 ? '#e74c3c' : urgency < 0.4 ? '#f39c12' : '#2ecc71';
    ctx.textAlign = 'center';
    ctx.font      = 'bold 11px Arial';
    ctx.fillStyle = '#667';
    ctx.fillText('TIME', W / 2, 20);
    ctx.font      = 'bold 32px Arial';
    ctx.fillStyle = urgency < 0.2 ? '#e74c3c' : urgency < 0.4 ? '#f39c12' : '#2ecc71';
    ctx.fillText(timeLeft, W / 2, 50);

    // „Çπ„Ç≥„Ç¢
    ctx.textAlign = 'right';
    ctx.font      = 'bold 11px Arial';
    ctx.fillStyle = '#667';
    ctx.fillText('SCORE', W - 14, 20);
    ctx.font      = 'bold 22px Arial';
    ctx.fillStyle = '#f39c12';
    ctx.fillText(totalScore.toLocaleString(), W - 14, 50);

    // „Çπ„Éî„Éº„ÉâË°®Á§∫
    const elapsed   = cfg.timeLimit - timeLeft;
    const speedMult = 1 + elapsed * 0.008;
    if (speedMult > 1.2) {
      const alpha   = 0.55 + 0.45 * Math.sin(Date.now() / 180);
      ctx.globalAlpha = alpha;
      ctx.textAlign   = 'center';
      ctx.font        = 'bold 11px Arial';
      ctx.fillStyle   = '#e74c3c';
      ctx.fillText(`üî• SPEED √ó${speedMult.toFixed(1)}`, W / 2, HUD_H - 5);
      ctx.globalAlpha = 1;
    }
  }

  // ‚îÄ‚îÄ „Éñ„É≠„ÉÉ„ÇØ ‚îÄ‚îÄ
  function renderBlocks() {
    for (const b of blocks) {
      if (!b.alive) continue;
      const isKey = b.type === 'key';

      if (isKey) { ctx.shadowColor = '#f5c842'; ctx.shadowBlur = 14; }

      // Â°ó„Çä
      const grad = ctx.createLinearGradient(b.x, b.y, b.x, b.y + BLOCK_H);
      if (isKey) {
        grad.addColorStop(0, '#f5d050');
        grad.addColorStop(1, '#e07e10');
      } else {
        grad.addColorStop(0, '#2c3e7a');
        grad.addColorStop(1, '#18254e');
      }
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.roundRect(b.x, b.y, BLOCK_W, BLOCK_H, 5); ctx.fill();

      ctx.shadowBlur = 0;

      // Êû†Á∑ö
      ctx.strokeStyle = isKey ? 'rgba(255,210,60,0.9)' : 'rgba(74,144,217,0.45)';
      ctx.lineWidth   = 1.5;
      ctx.beginPath(); ctx.roundRect(b.x, b.y, BLOCK_W, BLOCK_H, 5); ctx.stroke();

      // „É©„Éô„É´
      ctx.textAlign = 'center';
      if (isKey) {
        ctx.font = '14px Arial';
        ctx.fillText('üîë', b.x + BLOCK_W / 2, b.y + BLOCK_H / 2 + 5);
      } else {
        ctx.fillStyle = 'rgba(100,150,220,0.6)';
        ctx.font      = 'bold 11px Arial';
        ctx.fillText('‚ñ†', b.x + BLOCK_W / 2, b.y + BLOCK_H / 2 + 4);
      }
    }
  }

  // ‚îÄ‚îÄ „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ ‚îÄ‚îÄ
  function renderParticles() {
    for (const p of particles) {
      ctx.globalAlpha = Math.max(0, p.life);
      ctx.fillStyle   = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * Math.max(0, p.life), 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  // ‚îÄ‚îÄ „Çø„Ç§„É†„Éú„Éº„Éä„Çπ„ÉÜ„Ç≠„Çπ„Éà ‚îÄ‚îÄ
  function renderTimeBonuses() {
    ctx.textAlign = 'center';
    ctx.font      = 'bold 20px Arial';
    for (const tb of timeBonuses) {
      ctx.globalAlpha  = Math.max(0, tb.life);
      ctx.fillStyle    = '#2ecc71';
      ctx.shadowColor  = '#2ecc71';
      ctx.shadowBlur   = 10;
      ctx.fillText('+10s', tb.x, tb.y);
    }
    ctx.globalAlpha = 1;
    ctx.shadowBlur  = 0;
  }

  // ‚îÄ‚îÄ „Éë„Éâ„É´ ‚îÄ‚îÄ
  function renderPaddle() {
    ctx.shadowColor = '#74b9ff';
    ctx.shadowBlur  = 22;

    const grad = ctx.createLinearGradient(paddleX, PADDLE_Y, paddleX, PADDLE_Y + PADDLE_H);
    grad.addColorStop(0, '#74b9ff');
    grad.addColorStop(1, '#0984e3');
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.roundRect(paddleX, PADDLE_Y, PADDLE_W, PADDLE_H, 7); ctx.fill();

    ctx.shadowBlur = 0;

    // „Éè„Ç§„É©„Ç§„Éà
    ctx.fillStyle = 'rgba(255,255,255,0.28)';
    ctx.beginPath(); ctx.roundRect(paddleX + 7, PADDLE_Y + 2, PADDLE_W - 14, 4, 2); ctx.fill();
  }

  // ‚îÄ‚îÄ „Éú„Éº„É´ ‚îÄ‚îÄ
  function renderBall() {
    ctx.shadowColor = '#ffffff';
    ctx.shadowBlur  = 20;
    ctx.fillStyle   = '#ffffff';
    ctx.beginPath(); ctx.arc(ball.x, ball.y, BALL_R, 0, Math.PI * 2); ctx.fill();

    // ÂÖâÊ≤¢
    ctx.shadowBlur  = 0;
    ctx.fillStyle   = 'rgba(180,220,255,0.55)';
    ctx.beginPath(); ctx.arc(ball.x - 2.5, ball.y - 2.5, BALL_R * 0.38, 0, Math.PI * 2); ctx.fill();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  „Ç≤„Éº„É†„É´„Éº„Éó
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let lastTs = 0;

  function loop(ts) {
    const dt = Math.min((ts - lastTs) / 1000, 0.05);
    lastTs   = ts;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  // Ëµ∑Âãï
  updateCharPanel();
  requestAnimationFrame(ts => { lastTs = ts; requestAnimationFrame(loop); });
  </script>
</body>
</html>
